@model System.Data.DataTable

@{
    ViewBag.Title = "Super Admin Dashboard";
}

<h2 class="text-center mt-3">Pending Admin Approvals</h2>

@if (TempData["success"] != null)
{
    <div class="alert alert-success">@TempData["success"]</div>
}

@if (TempData["error"] != null)
{
    <div class="alert alert-danger">@TempData["error"]</div>
}

<table class="table table-bordered table-striped mt-4">
    <thead class="table-dark">
        <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Phone No</th>
            <th>Request Date</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
        @foreach (System.Data.DataRow row in Model.Rows)
        {
            <tr>
                <td>@row["FullName"]</td>
                <td>@row["Email"]</td>
                <td>@row["PhoneNo"]</td>
                <td>@row["CreatedOn"]</td>

                <!-- STATUS -->
                <td>
                    <span class="badge 
                        @(row["Status"].ToString() == "Pending" ? "bg-warning" :
                          row["Status"].ToString() == "Verified" ? "bg-info" :
                          "bg-success")">
                        @row["Status"]
                    </span>
                </td>

                <!-- ACTION BUTTONS -->
                <td>
                    @if (row["Status"].ToString() == "Pending")
                    {
                        <a href="/SuperAdmin/Verify/@row["RequestID"]"
                           class="btn btn-warning btn-sm">
                            Verify
                        </a>
                    }

                    @if (row["Status"].ToString() == "Verified")
                    {
                        <a href="/SuperAdmin/Approve/@row["RequestID"]"
                           class="btn btn-success btn-sm">
                            Approve
                        </a>
                    }

                    <a href="/SuperAdmin/Decline/@row["RequestID"]"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Are you sure you want to decline this request?');">
                        Decline
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>





public ActionResult Verify(int id)
{
    using (SqlConnection con = new SqlConnection(connString))
    {
        con.Open();

        // Get admin email
        SqlCommand cmd = new SqlCommand(
            "SELECT FullName, Email FROM PendingAdminRequests WHERE RequestID=@ID",
            con);
        cmd.Parameters.AddWithValue("@ID", id);

        SqlDataReader dr = cmd.ExecuteReader();
        if (!dr.Read())
        {
            TempData["error"] = "Request not found!";
            return RedirectToAction("Dashboard");
        }

        string fullName = dr["FullName"].ToString();
        string email = dr["Email"].ToString();
        dr.Close();

        // Update status to VERIFIED
        SqlCommand updateCmd = new SqlCommand(
            "UPDATE PendingAdminRequests SET Status='Verified', VerifiedOn=GETDATE() WHERE RequestID=@ID",
            con);
        updateCmd.Parameters.AddWithValue("@ID", id);
        updateCmd.ExecuteNonQuery();

        // Send verification email
        SendVerificationEmail(email, fullName);

        TempData["success"] = "Admin request verified. Email sent.";
    }

    return RedirectToAction("Dashboard");
}




private void SendVerificationEmail(string email, string fullName)
{
    try
    {
        MailMessage mail = new MailMessage();
        mail.To.Add(email);
        mail.From = new MailAddress("stayeasepgbooking@gmail.com");
        mail.Subject = "StayEase Admin Verification";

        mail.Body =
$@"Hello {fullName},

Your admin request has been verified.

Please submit the following to proceed:
• PG details
• ID proof
• Property documents

After verification, your account will be approved.

Thank you,
StayEase Team";

        SmtpClient smtp = new SmtpClient("smtp.gmail.com", 587);
        smtp.EnableSsl = true;
        smtp.Credentials = new NetworkCredential(
            "stayeasepgbooking@gmail.com",
            "fstz tzcr yxbj bkbx");

        smtp.Send(mail);
    }
    catch { }
}
